(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(e+Math.random()*(t+1-e));window.utilModule={getRatio:(e,t,o)=>(t-e)*o/100+e,getRandomInteger:e,getRandomArrayItem:t=>t[e(0,t.length-1)],clearElement:(e,t)=>{const o=e.children;for(let n=o.length-1;n>=0;n--)t&&t.includes(o[n].tagName.toLowerCase(),0)||e.removeChild(o[n])},isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}}})(),window.debounce=(e,t=500)=>{let o=!1;return(...n)=>{o||(e(...n),o=!0,setTimeout((()=>{o=!1}),t))}},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector("#picture-cancel"),o=e.querySelector(".social__caption"),n=e.querySelector(".likes-count"),l=e.querySelector(".social__comment-count"),i=e.querySelector(".social__comments"),r=e.querySelector(".social__comment"),s=e.querySelector(".comments-loader"),a=document.querySelector("body");l.innerHTML="<span></span>"+l.innerHTML.slice(1);const d=l.querySelector("span"),u=l.querySelector(".comments-count"),c=()=>{const e=Array.from(i.querySelectorAll(".hidden")),t=e.length<=5?e.length:5;e.forEach((e=>{e.classList.remove("hidden")})),e.splice(0,t),e.length||(s.classList.add("hidden"),s.removeEventListener("click",c)),d.textContent=+d.textContent+t},m=()=>{e.classList.add("hidden"),a.classList.remove("modal-open"),document.removeEventListener("keydown",g),t.removeEventListener("click",m)},g=e=>{window.utilModule.isEscEvent(e,m)};window.previewModule={openBigPicture:l=>{e.classList.remove("hidden"),a.classList.add("modal-open"),e.querySelector(".big-picture__img img").src=l.url,n.textContent=l.likes,u.textContent=l.comments.length,o.textContent=l.description,window.utilModule.clearElement(i),(e=>{let t=e.length;e.forEach(((e,o)=>{let n=(e=>{const t=r.cloneNode(!0),o=t.querySelector("img");return o.src=e.avatar,o.alt=e.name,t.querySelector(".social__text").textContent=e.message,t})(e);i.appendChild(n),o>4&&(n.classList.add("hidden"),t-=1)})),d.textContent=t})(l.comments),l.comments.length>5?(s.classList.remove("hidden"),s.addEventListener("click",c)):s.classList.add("hidden"),document.addEventListener("keydown",g),t.addEventListener("click",m)}}})(),(()=>{const e=document.querySelector("#picture").content,t=document.querySelector(".pictures"),o=document.createDocumentFragment();window.picturesRenderingModule={renderPictures:n=>{n.forEach((n=>{const l=e.cloneNode(!0);l.querySelector(".picture__img").src=n.url,l.querySelector(".picture__likes").textContent=n.likes,l.querySelector(".picture__comments").textContent=n.comments.length,l.querySelector(".picture").addEventListener("click",(()=>{window.previewModule.openBigPicture(n)})),o.appendChild(l),t.appendChild(o)}))}}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelectorAll(".img-filters__button"),o=document.querySelector(".pictures");window.picturesFiltersModule={activateFilters:n=>{e.classList.remove("img-filters--inactive"),e.addEventListener("click",(e=>window.debounce((n=>{let l;var i;l=n.target.matches("#filter-random")?(e=>{const t=[];for(let o=0;o<10;){const n=window.utilModule.getRandomArrayItem(e);t.includes(n)||(t.push(n),o++)}return t})(e):n.target.matches("#filter-discussed")?(e=>e.slice(0).sort(((e,t)=>{let o=t.comments.length-e.comments.length;return 0===o&&(o=1),o})))(e):e,window.utilModule.clearElement(o,["h2","section"]),window.picturesRenderingModule.renderPictures(l),i=n.target,t.forEach((e=>{e.classList.remove("img-filters__button--active")})),i.classList.add("img-filters__button--active")})))(n))}}})(),(()=>{const e=document.querySelector("body");window.galleryModule={loadPictures:e=>{window.picturesRenderingModule.renderPictures(e),window.picturesFiltersModule.activateFilters(e)},errorGalleryPictures:t=>{const o=document.createElement("div"),n=document.createElement("img"),l=document.createElement("span");n.src="img/icon-warning.svg",n.style="width: 30px; height: 30px; margin-right: 20px; vertical-align: bottom;",l.textContent=t,o.style='position: absolute; top: 10px; right: 0; left: 0; padding: 10px; font-family: "Open Sans", "Arial", sans-serif; text-align: center; font-weight: 700; font-size: 20px; color: #ffe753; background-color: #3c3614; border-radius: 10px;',o.classList.add("container"),o.appendChild(n),o.appendChild(l),e.appendChild(o)}}})(),window.upload=(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.timeout=1e4,n.addEventListener("load",t),n.addEventListener("error",o),n.addEventListener("timeout",o),n.open("POST","https://21.javascript.pages.academy/kekstagram"),n.send(e)},(()=>{const e=document.querySelector("body").querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error");let n;const l=()=>{n.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",r)},i=e=>{window.utilModule.isEscEvent(e,l)},r=e=>{e.target.matches(`.${status}__inner`)||(e.preventDefault(),l())};window.uploadFormStatusMessageModule={openStatusMessage:s=>{"success"===s?n=t.cloneNode(!0):"error"===s&&(n=o.cloneNode(!0)),document.addEventListener("keydown",i),document.addEventListener("click",r),n.querySelector(`.${s}__button`).addEventListener("click",l),e.appendChild(n)}}})(),(()=>{const e={chrome:{minValue:0,maxValue:1,getLevel(e){return`grayscale(${window.utilModule.getRatio(this.minValue,this.maxValue,e)})`}},sepia:{minValue:0,maxValue:1,getLevel(e){return`sepia(${window.utilModule.getRatio(this.minValue,this.maxValue,e)})`}},marvin:{minValue:0,maxValue:1,getLevel(e){return`invert(${window.utilModule.getRatio(this.minValue,this.maxValue,e)})`}},phobos:{minValue:0,maxValue:3,getLevel(e){return`blur(${window.utilModule.getRatio(this.minValue,this.maxValue,e)}px)`}},heat:{minValue:1,maxValue:3,getLevel(e){return`brightness(${window.utilModule.getRatio(this.minValue,this.maxValue,e)})`}}},t=document.querySelector(".img-upload__overlay"),o=t.querySelector(".img-upload__preview img"),n=t.querySelector(".effect-level"),l=n.querySelector(".effect-level__value"),i=n.querySelector(".effect-level__line"),r=i.querySelector(".effect-level__depth"),s=i.querySelector(".effect-level__pin"),a=t.querySelector(".scale__control--value");let d,u,c;const m=()=>{n.classList.add("hidden"),s.style.left="100%",r.style.width="100%",o.classList.remove(c),o.style.filter="",l.setAttribute("value",100)},g=t=>{o.style.filter=e[u].getLevel(t),s.style.left=t+"%",r.style.width=t+"%",l.setAttribute("value",t)};window.uploadFormImageSettingsModule={onPlusScaleButtonClick:()=>{d<100&&(d+=25,a.value=d+"%",o.style.transform=`scale(${d/100})`)},onMinusScaleButtonClick:()=>{d>25&&(d-=25,a.value=d+"%",o.style.transform=`scale(${d/100})`)},getDefaultScaleSettings:()=>{d=100,a.value=d+"%",o.style.transform=`scale(${d/100})`},getDefaultEffectSettings:m,onEffectChange:t=>{t.target.matches('input[type="radio"]')&&(m(),"none"!==t.target.value&&(u=t.target.value,c="effects__preview--"+u,o.classList.add(c),o.style.filter=e[u].getLevel(100),n.classList.remove("hidden")))},onEffectPinMouseDown:()=>{const e=e=>{const t=(e.clientX-i.getBoundingClientRect().left)/i.offsetWidth*100;g(t>100?100:t<0?0:t)},t=()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)},onEffectRangeClick:e=>{const t=(e.clientX-i.getBoundingClientRect().left)/i.offsetWidth*100;g(t)},onEffectPinKeydown:e=>{const t=+s.style.left.slice(0,-1);"ArrowLeft"===e.key?t>=1?g(t-1):t>0&&t<1&&g(0):"ArrowRight"===e.key&&(t<=99?g(t+1):t<100&&t>99&&g(100))}}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".text__hashtags"),o=e.querySelector(".text__description"),n=/^#[a-zA-Zа-яА-Я0-9]*$/;window.uploadFormValidityModule={onHashtagInputInput:()=>{if(t.value){const e=t.value.toLowerCase().split(" ");if(e.forEach((t=>{""===t&&e.splice(1)})),e.length>5)t.setCustomValidity("Нельзя указать больше 5 хэштегов");else for(let o=0;o<e.length;o++){if(e.includes(e[o],o+1)){t.setCustomValidity("Один и тот же хэштег не может быть использован дважды");break}if(e[o].length>20){t.setCustomValidity("Длина хэштега не должна превышать 20 симв.");break}if("#"!==e[o][0]){t.setCustomValidity("Хэштег должен начинаться с символа решётки");break}if(1===e[o].length){t.setCustomValidity("Хэштег не должен состоять только из одной решётки");break}if(!n.test(e[o])){t.setCustomValidity("Хэштег не должен содержать специальных символов");break}t.setCustomValidity("")}}else t.setCustomValidity("");t.reportValidity(),""!==t.validationMessage?t.style.boxShadow="0 0 0 2px #ff4e4e":t.style.boxShadow="none"},onCommentInputInput:()=>{const e=o.value.length;e>140?o.setCustomValidity(`Удалите лишние ${e-140} симв.`):o.setCustomValidity(""),o.reportValidity(),""!==t.validationMessage?t.style.boxShadow="0 0 0 2px #ff4e4e":t.style.boxShadow="none"}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__overlay"),o=e.querySelector("#upload-file"),n=t.querySelector(".img-upload__cancel"),l=t.querySelector(".img-upload__preview img"),i=t.querySelectorAll(".effects__preview"),r=t.querySelector(".effect-level").querySelector(".effect-level__line"),s=r.querySelector(".effect-level__pin"),a=e.querySelector(".scale__control--bigger"),d=e.querySelector(".scale__control--smaller"),u=e.querySelector(".text__hashtags"),c=e.querySelector(".text__description"),m=document.querySelector("body"),g=e=>{window.utilModule.isEscEvent(e,(()=>{document.activeElement!==u&&document.activeElement!==c&&y()}))},p=t=>{t.preventDefault(),window.upload(new FormData(e),w,v)},w=()=>{window.uploadFormStatusMessageModule.openStatusMessage("success"),y()},v=()=>{window.uploadFormStatusMessageModule.openStatusMessage("error"),y()},y=()=>{t.classList.add("hidden"),m.classList.remove("modal-open"),e.reset(),window.uploadFormImageSettingsModule.getDefaultEffectSettings(),window.uploadFormImageSettingsModule.getDefaultScaleSettings(),document.removeEventListener("keydown",g),n.removeEventListener("click",y),e.removeEventListener("change",window.uploadFormImageSettingsModule.onEffectChange),r.removeEventListener("click",window.uploadFormImageSettingsModule.onEffectRangeClick),s.removeEventListener("mousedown",window.uploadFormImageSettingsModule.onEffectPinMouseDown),s.removeEventListener("keydown",window.uploadFormImageSettingsModule.onEffectPinKeydown),a.removeEventListener("click",window.uploadFormImageSettingsModule.onPlusScaleButtonClick),d.removeEventListener("click",window.uploadFormImageSettingsModule.onMinusScaleButtonClick),u.removeEventListener("input",window.uploadFormValidityModule.onHashtagInputInput),c.removeEventListener("input",window.uploadFormValidityModule.onCommentInputInput),e.removeEventListener("submit",p)};window.pictureModule={uploadPhoto:()=>{const e=URL.createObjectURL(o.files[0]);l.src=e,i.forEach((t=>{t.style.backgroundImage=`url(${e})`}))},openUploadPopup:()=>{t.classList.remove("hidden"),m.classList.add("modal-open"),document.addEventListener("keydown",g),n.addEventListener("click",y),e.addEventListener("change",window.uploadFormImageSettingsModule.onEffectChange),r.addEventListener("click",window.uploadFormImageSettingsModule.onEffectRangeClick),s.addEventListener("mousedown",window.uploadFormImageSettingsModule.onEffectPinMouseDown),s.addEventListener("keydown",window.uploadFormImageSettingsModule.onEffectPinKeydown),a.addEventListener("click",window.uploadFormImageSettingsModule.onPlusScaleButtonClick),d.addEventListener("click",window.uploadFormImageSettingsModule.onMinusScaleButtonClick),u.addEventListener("input",window.uploadFormValidityModule.onHashtagInputInput),c.addEventListener("input",window.uploadFormValidityModule.onCommentInputInput),e.addEventListener("submit",p)}}})(),window.load=(e,t,o,n,l,i)=>{const r=new XMLHttpRequest;r.responseType="json",r.timeout=l,r.addEventListener("load",(()=>{200===r.status?o(r.response):n("Статус ответа: "+r.status+" "+r.statusText)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+r.timeout+"мс")})),r.open(t,e),i?r.send(i):r.send()},(()=>{window.load("https://21.javascript.pages.academy/kekstagram/data","GET",window.galleryModule.loadPictures,window.galleryModule.errorGalleryPictures,1e4);const e=document.querySelector(".img-upload__input");window.uploadFormImageSettingsModule.getDefaultEffectSettings(),window.uploadFormImageSettingsModule.getDefaultScaleSettings(),e.addEventListener("change",(()=>{window.pictureModule.uploadPhoto(),window.pictureModule.openUploadPopup()}))})()})();